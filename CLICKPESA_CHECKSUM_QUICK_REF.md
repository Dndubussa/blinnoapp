# ClickPesa Checksum Fix - Quick Reference\n\n## What Was Fixed\n\n❌ **Before**: `Invalid checksum` error on hosted checkout requests  \n✅ **After**: Proper HMAC-SHA256 checksum calculation with canonical JSON\n\n## The Problem\n\nClickPesa requires all hosted checkout requests to include a checksum calculated from the request payload. The previous implementation was missing this checksum entirely.\n\n## The Solution\n\nImplemented two new functions in the `clickpesa-payment` Edge Function:\n\n### 1. `canonicalize()` - Recursive Key Sorting\nEnsures consistent key ordering at all nesting levels for deterministic serialization.\n\n### 2. `createPayloadChecksum()` - HMAC-SHA256 Generation\nCalculates the checksum using Web Crypto API:\n- Canonicalizes the payload\n- Serializes to compact JSON\n- Generates HMAC-SHA256 with the checksum secret\n- Returns hex-encoded result\n\n## Required Setup\n\nAdd this environment variable to your Supabase project:\n\n```\nCLICKPESA_CHECKSUM_SECRET=your_checksum_secret_from_clickpesa_dashboard\n```\n\n**⚠️ Important**: After setting this, you may need to regenerate your API tokens in the ClickPesa dashboard.\n\n## How It Works\n\n```\nUser initiates checkout\n       ↓\ncreate-hosted-checkout action sent to Edge Function\n       ↓\nFunction receives: { amount, currency, reference, description, etc. }\n       ↓\nPayload is canonicalized (keys sorted alphabetically)\n       ↓\nCanonical JSON serialized: {\"amount\":750,\"currency\":\"TZS\",...}\n       ↓\nHMAC-SHA256(payload, secret) → generates 64-char hex checksum\n       ↓\nChecksum added to request: {\"amount\":750,...,\"checksum\":\"abc123...\"}\n       ↓\nRequest sent to ClickPesa API\n       ↓\nClickPesa validates checksum matches their calculation\n       ↓\nIf valid: ✅ Returns checkout_url\nIf invalid: ❌ Returns \"Invalid checksum\" error\n```\n\n## Testing\n\n### Frontend Code\nNo changes needed! The Edge Function handles checksum generation automatically.\n\n### Manual Test with cURL\n```bash\ncurl -X POST \\\n  https://your-project.supabase.co/functions/v1/clickpesa-payment \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer YOUR_JWT\" \\\n  -d '{\n    \"action\": \"create-hosted-checkout\",\n    \"amount\": 750,\n    \"currency\": \"TZS\",\n    \"reference\": \"ORDER-TEST-001\",\n    \"description\": \"Test Payment\",\n    \"redirect_url\": \"https://www.blinno.app/checkout/success\"\n  }'\n```\n\n### Expected Response\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"checkout_id\": \"abc123...\",\n    \"checkout_url\": \"https://pay.clickpesa.com/...\"\n  },\n  \"checkout_url\": \"https://pay.clickpesa.com/...\"\n}\n```\n\n## Troubleshooting\n\n| Error | Cause | Solution |\n|-------|-------|----------|\n| `Invalid checksum` | Secret not set or mismatched | Verify `CLICKPESA_CHECKSUM_SECRET` environment variable |\n| `500 error` | Checksum generation failed | Check logs for crypto API errors |\n| `Missing CLICKPESA_CHECKSUM_SECRET` | Environment variable not set | Add to Supabase secrets |\n\n## Key Points\n\n✅ **Canonical JSON**: Keys are sorted to ensure consistent ordering  \n✅ **HMAC-SHA256**: Industry-standard cryptographic hash  \n✅ **Web Crypto API**: Native browser/Deno crypto support  \n✅ **Error Handling**: Graceful fallback if secret is missing  \n✅ **Detailed Logging**: Debug logs show payload and checksum  \n\n## File Modified\n\n- `supabase/functions/clickpesa-payment/index.ts` (Lines: +200)\n\n## Deployment Status\n\n✅ **Version**: 33 (ACTIVE)  \n✅ **Date**: January 5, 2026  \n✅ **Status**: Ready for Production\n\n## References\n\n- ClickPesa Checksum Docs: https://docs.clickpesa.com/home/checksum\n- Web Crypto API: https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API\n- JSON Canonicalization: https://tools.ietf.org/html/rfc8785\n